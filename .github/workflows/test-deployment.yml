# After a new release of Docker Compose is synced from the Rasa Studio repo, this workflow is used to test the deployment of the new release.
# It spins up the Docker Compose services and waits for the startup-helper service to complete, or alerts us in Slack if the deployment fails.
name: Setup and Test Deployment

on:
  push:
    branches:
      - main
  pull_request:

env:
  RASA_PRO_LICENSE: ${{ secrets.RASA_PRO_LICENSE }}

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  test-deployment:
    runs-on: ubuntu-24.04-4core
    timeout-minutes: 10
    steps:
      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd #v6.0.2
        with:
          fetch-depth: 1

      - name: Create and set permissions for working directories
        shell: bash
        run: |
          sudo chown -R 1001:1001 rasa-pro
          sudo chmod -R 775 rasa-pro

      - name: Start Docker Compose
        id: start_docker_compose
        shell: bash
        run: |
          docker compose up -d
          echo "Waiting for services to start..."

      - name: Wait for startup-helper to complete
        id: wait_for_startup
        shell: bash
        run: |
          timeout=600  # 10 minutes timeout
          start_time=$(date +%s)
          while true; do
          if docker compose logs startup-helper | grep -q "Rasa Studio is ready!"; then
              echo "✅ Startup completed successfully"
              break
          fi

          current_time=$(date +%s)
          elapsed=$((current_time - start_time))

          if [ $elapsed -ge $timeout ]; then
              echo "❌ Timeout waiting for services to start"
              docker compose logs
              exit 1
          fi

          sleep 10
          echo "Still waiting for services to start... (${elapsed}s elapsed)"
          done

      - name: Save Docker Compose logs
        if: always() && (steps.start_docker_compose.outcome == 'failure' || steps.wait_for_startup.outcome == 'failure')
        shell: bash
        run: |
          echo "Saving Docker Compose logs due to startup or test failure..."
          docker compose logs > docker compose.log

      - name: Upload docker compose logs
        if: always() && (steps.start_docker_compose.outcome == 'failure' || steps.wait_for_startup.outcome == 'failure')
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 #v4.6.2
        with:
          name: docker compose-logs-${{ github.sha }}
          path: docker compose.log

      - name: Notify Slack on failure
        if: failure() && !cancelled()
        uses: slackapi/slack-github-action@485a9d42d3a73031f12ec201c457e2162c45d02d # v2.0.0
        with:
          webhook: ${{ secrets.SLACK_CODESECURITY_WEBHOOK_URL }}
          webhook-type: incoming-webhook
          payload: |
            {
              "text": "*Studio Docker Compose New Release:* Testing the deployment after a sync has failed :rotating_light:\nRepository: ${{ github.repository }}\nRun: <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|Open run>\n\n${{ steps.summary.outputs.summary }}",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Studio Docker Compose New Release:* Testing the deployment after a sync has failed :rotating_light:\n*Repository:* `${{ github.repository }}`\n*Run:* <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|Open run>\n\n${{ steps.summary.outputs.summary }}"
                  }
                }
              ]
            }