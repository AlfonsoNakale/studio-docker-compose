name: Setup and Test Deployment

on:
  push:
    branches:
      - main
  pull_request:

env:
  RASA_PRO_LICENSE: ${{ secrets.RASA_PRO_LICENSE }}

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  test-deployment:
    runs-on: ubuntu-24.04-4core
    timeout-minutes: 10
    steps:
      - name: Checkout code
        uses: actions/checkout@3df4ab11eba7bda6032a0b82a6bb43b11571feac
        with:
          fetch-depth: 1

      - name: Create and set permissions for working directories
        shell: bash
        run: |
          sudo chown -R 1001:1001 rasa-pro
          sudo chmod -R 775 rasa-pro

      - name: Start Docker Compose
        id: start_docker_compose
        shell: bash
        run: |
          docker compose up -d
          echo "Waiting for services to start..."

      - name: Wait for startup-helper to complete
        id: wait_for_startup
        shell: bash
        run: |
          timeout=600  # 10 minutes timeout
          start_time=$(date +%s)
          while true; do
          if docker compose logs startup-helper | grep -q "Rasa Studio is ready!"; then
              echo "✅ Startup completed successfully"
              break
          fi

          current_time=$(date +%s)
          elapsed=$((current_time - start_time))

          if [ $elapsed -ge $timeout ]; then
              echo "❌ Timeout waiting for services to start"
              docker compose logs
              exit 1
          fi

          sleep 10
          echo "Still waiting for services to start... (${elapsed}s elapsed)"
          done

      - name: Save Docker Compose logs
        if: always() && (steps.start_docker_compose.outcome == 'failure' || steps.wait_for_startup.outcome == 'failure')
        shell: bash
        run: |
          echo "Saving Docker Compose logs due to startup or test failure..."
          docker compose logs > docker compose.log

      - name: Upload docker compose logs
        if: always() && (steps.start_docker_compose.outcome == 'failure' || steps.wait_for_startup.outcome == 'failure')
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 #v4.6.2
        with:
          name: docker compose-logs-${{ github.sha }}
          path: docker compose.log
